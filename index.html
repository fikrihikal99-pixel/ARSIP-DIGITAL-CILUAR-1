<!-- Versi HTML Online Terintegrasi Apps Script -->
<!-- File ini sudah di-rebuild (Pilihan A). Terhubung ke Apps Script publik milikmu untuk upload/list/delete -->

<!doctype html>
<html lang="id" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Arsip Digital SDN Ciluar 1 ‚Äî Online</title>
  <style>
    /* Minimal UI CSS (responsive & ringan) */
    *{box-sizing:border-box;font-family:Arial, sans-serif}
    body{margin:0;background:#FFF8E7;color:#2C3E50}
    .container{max-width:980px;margin:24px auto;padding:16px}
    header{display:flex;justify-content:space-between;align-items:center;padding:12px 0}
    .card{background:#fff;border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,0.08);}
    .flex{display:flex} .gap-8{gap:8px} .gap-4{gap:8px}
    input[type=text],select,input[type=file]{width:100%;padding:10px;border:2px solid #E6F4F0;border-radius:8px}
    button{padding:10px 14px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
    .btn-primary{background:#FF6B6B;color:#fff}
    .btn-secondary{background:#4ECDC4;color:#fff}
    .list-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:8px;border:1px solid #f0f0f0;margin-bottom:10px}
    .muted{opacity:.7;font-size:0.95rem}
    .small{font-size:0.9rem}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1 style="margin:0">üìö Arsip Digital SDN Ciluar 1</h1>
        <div class="muted small">Aplikasi online ‚Äî terhubung ke Google Drive melalui Apps Script</div>
      </div>
      <div>
        <a href="#" id="refreshBtn" class="btn btn-secondary">Refresh</a>
      </div>
    </header>

    <section class="card" id="uploader">
      <h2 style="margin-top:0">üì§ Upload File</h2>
      <form id="formUpload">
        <div style="margin-bottom:8px">
          <label>Nama file (opsional)</label>
          <input type="text" id="fileName" placeholder="Contoh: SK Pembagian Tugas" />
        </div>
        <div style="margin-bottom:8px">
          <label>Kategori</label>
          <select id="category">
            <option>Administrasi</option>
            <option>Kurikulum</option>
            <option>Kesiswaan</option>
            <option>Surat</option>
            <option>Lainnya</option>
          </select>
        </div>
        <div style="margin-bottom:12px">
          <input type="file" id="fileInput" accept="image/*,.pdf" required />
        </div>
        <div style="display:flex;gap:8px">
          <button type="submit" class="btn btn-primary">Upload ke Drive</button>
          <button type="button" id="uploadLocal" class="btn" style="background:#999;color:#fff">Simpan Lokal (jika perlu)</button>
        </div>
        <div id="status" style="margin-top:10px;color:#333"></div>
      </form>
    </section>

    <section style="margin-top:16px" class="card">
      <h2 style="margin-top:0">üìÅ Daftar Arsip</h2>
      <div id="filesList"></div>
      <div id="emptyNotice" class="muted" style="display:none">Belum ada file di folder Drive.</div>
    </section>

    <footer style="margin-top:12px;text-align:center;color:#666;font-size:0.9rem">Terhubung ke Apps Script: <span id="apiUrl"></span></footer>
  </div>

<script>
// === CONFIG ===
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyuR18FhSoPEsPmX6tp4s9NcQOcEv9moXxe7oGeA3dwwJJgk68D_h1gEjoY5heF1QKE/exec';
// Catatan: Pastikan Apps Script yang kamu deploy mendukung GET => daftar file, dan POST => upload.

// === STATE ===
let files = [];
const $ = id => document.getElementById(id);
$('apiUrl').textContent = WEB_APP_URL;

// === HELPERS ===
function toLocalTimeString(dateStr){
  try{ return new Date(dateStr).toLocaleString('id-ID'); }catch(e){return dateStr}
}

function showStatus(msg, timeout=3000){
  $('status').textContent = msg;
  if(timeout) setTimeout(()=>{$('status').textContent='';}, timeout);
}

// === RENDER ===
function renderFiles(){
  const list = $('filesList');
  list.innerHTML='';
  if(!files || files.length===0){
    $('emptyNotice').style.display='block';
    return;
  }
  $('emptyNotice').style.display='none';

  files.forEach(f=>{
    const div = document.createElement('div');
    div.className='list-item';

    const left = document.createElement('div');
    left.innerHTML = `<div style="font-weight:700">${escapeHtml(f.name || f.fileName)}</div>
                      <div class="muted small">${f.mime||f.fileType||''} ‚Ä¢ ${f.size?f.size+' bytes':''} ‚Ä¢ ${f.date?toLocalTimeString(f.date):''}</div>`;

    const right = document.createElement('div');
    right.style.display='flex'; right.style.gap='8px';

    const btnView = document.createElement('a');
    btnView.textContent='Lihat';
    btnView.className='btn btn-secondary';
    btnView.href = f.url || f.webViewLink || f.fileData || '#';
    btnView.target='_blank';

    const btnDownload = document.createElement('button');
    btnDownload.textContent='Unduh';
    btnDownload.className='btn';
    btnDownload.style.background='#0B74DE'; btnDownload.style.color='#fff';
    btnDownload.onclick = ()=>downloadByUrl(f);

    const btnDelete = document.createElement('button');
    btnDelete.textContent='Hapus';
    btnDelete.className='btn';
    btnDelete.style.background='#E74C3C'; btnDelete.style.color='#fff';
    btnDelete.onclick = ()=>confirmDelete(f.id || f.fileId || f.id);

    right.appendChild(btnView);
    right.appendChild(btnDownload);
    right.appendChild(btnDelete);

    div.appendChild(left);
    div.appendChild(right);
    list.appendChild(div);
  });
}

function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); }

// === NETWORK: list files from Apps Script ===
async function fetchFiles(){
  try{
    showStatus('Mengambil daftar file...');
    const res = await fetch(WEB_APP_URL);
    if(!res.ok) throw new Error('Status: '+res.status);
    const data = await res.json();
    if(data && data.files){
      // apps script format: id, name, url, size, date, mime
      files = data.files.map(f => ({ id:f.id, name:f.name, url:f.url, size:f.size, date:f.date, mime:f.mime }));
      renderFiles();
      showStatus('Daftar file berhasil dimuat',1500);
    } else if(Array.isArray(data)){
      // some scripts might return array directly
      files = data;
      renderFiles();
      showStatus('Daftar file berhasil dimuat',1500);
    } else {
      files = [];
      renderFiles();
      showStatus('Tidak ada file atau format respons tidak dikenal',3000);
      console.log('Respons fetchFiles:', data);
    }
  }catch(err){
    console.error('fetchFiles error',err);
    showStatus('Gagal ambil daftar file ‚Äî cek console',5000);
  }
}

// === UPLOAD: send base64 via POST (Apps Script expects urlencoded with file base64) ===
async function uploadToAppsScript(file, metaName, category){
  try{
    showStatus('Membaca file...');
    const reader = new FileReader();
    reader.onload = async function(e){
      const base64 = e.target.result.split(',')[1];
      showStatus('Uploading ke Drive... (lagi beberapa detik)');
      const body = new URLSearchParams();
      body.append('file', base64);
      body.append('name', metaName || file.name);
      body.append('type', file.type || 'application/octet-stream');
      body.append('category', category || 'Lainnya');

      const res = await fetch(WEB_APP_URL, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: body.toString() });
      const j = await res.json();
      if(res.ok && j && j.status==='success'){
        showStatus('Sukses upload: ' + (j.name || j.id),4000);
        await fetchFiles();
      } else {
        console.error('upload error', j);
        showStatus('Upload gagal ‚Äî cek console',6000);
      }
    };
    reader.readAsDataURL(file);
  }catch(err){console.error(err);showStatus('Upload gagal ‚Äî cek console',6000)}
}

// === DOWNLOAD helper ===
function downloadByUrl(file){
  // if url is Google Drive webViewLink, we open it (user can download from there)
  if(file.url && file.url.includes('drive.google.com')){
    window.open(file.url, '_blank');
    return;
  }
  // else if fileData (data URL) present, force download
  if(file.fileData && file.fileData.startsWith('data:')){
    const a=document.createElement('a');a.href=file.fileData;a.download=file.name||file.fileName;a.click();return;
  }
  // otherwise open url
  if(file.url) window.open(file.url, '_blank');
}

// === DELETE (try multiple ways: GET?delete=, POST action=delete) ===
async function confirmDelete(fileId){
  if(!confirm('Hapus file ini dari Drive?')) return;
  showStatus('Menghapus...');
  try{
    // Try 1: call GET?delete=
    let res = await fetch(WEB_APP_URL + '?delete=' + encodeURIComponent(fileId));
    if(res.ok){
      // some scripts return text
      await fetchFiles();
      showStatus('File dihapus',3000);
      return;
    }
  }catch(e){console.warn('delete via GET failed',e);} 

  try{
    // Try 2: POST action=delete (some scripts accept this)
    const body = new URLSearchParams(); body.append('action','delete'); body.append('id',fileId);
    const res2 = await fetch(WEB_APP_URL, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: body.toString() });
    if(res2.ok){ await fetchFiles(); showStatus('File dihapus',3000); return; }
  }catch(e){console.warn('delete via POST failed',e);} 

  showStatus('Gagal hapus ‚Äî cek console',6000);
}

// === UI HANDLERS ===
$('formUpload').addEventListener('submit', async function(e){
  e.preventDefault();
  const file = $('fileInput').files[0];
  if(!file){ alert('Pilih file dulu'); return; }
  const name = $('fileName').value.trim() || file.name;
  const category = $('category').value;
  await uploadToAppsScript(file, name, category);
});

$('uploadLocal').addEventListener('click', function(){
  // fallback: save a minimal record in localStorage
  showStatus('Menyimpan metadata lokal...');
  const file = $('fileInput').files[0];
  if(!file){ alert('Pilih file dulu'); return; }
  const db = JSON.parse(localStorage.getItem('arsipFiles')||'[]');
  db.push({id:Date.now(),fileName: $('fileName').value||file.name, category:$('category').value, uploadedBy:'Local', date:new Date().toISOString()});
  localStorage.setItem('arsipFiles', JSON.stringify(db));
  showStatus('Tersimpan lokal');
});

$('refreshBtn').addEventListener('click', function(e){ e.preventDefault(); fetchFiles(); });

// init
fetchFiles();
</script>
</body>
</html>
